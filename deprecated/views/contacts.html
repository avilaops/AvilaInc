<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contatos - Avila Dashboard</title>
    <link rel="stylesheet" href="/css/dashboard.css">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96" />
</head>
<body>
    <nav class="top-navbar">
        <div class="navbar-brand" onclick="window.location.href='/dashboard'">
            <span class="brand-logo">ğŸš€</span>
            <h1>Avila Dashboard</h1>
        </div>
        <div class="navbar-menu">
            <div class="menu-item" onclick="window.location.href='/dashboard'">Dashboard</div>
            <div class="menu-item active">Contatos</div>
            <div class="menu-item" onclick="window.location.href='/github'">GitHub</div>
            <div class="menu-item" onclick="window.location.href='/payments'">Pagamentos</div>
        </div>
    </nav>

    <main class="main-content">
        <section class="section active">
            <div class="section-header">
                <h1>ğŸ¤ Gerenciamento de Contatos</h1>
                <p>Gerencie seus leads, contatos unificados e pipeline de vendas</p>
            </div>

            <div class="crm-tabs">
                <button class="tab-btn active" onclick="showCrmTab('leads')">ğŸ“‹ Leads</button>
                <button class="tab-btn" onclick="showCrmTab('contacts')">ğŸ“ Contatos</button>
                <button class="tab-btn" onclick="showCrmTab('pipeline')">ğŸ“Š Pipeline</button>
            </div>

            <div id="crm-leads-tab" class="crm-tab active">
                <div class="crm-actions">
                    <button class="btn-primary" onclick="loadCrmLeads()">ğŸ”„ Atualizar Leads</button>
                    <button class="btn-secondary" onclick="sendMarketingEmails()">ğŸ“§ Enviar Emails</button>
                    <button class="btn-success" onclick="fazerBackupCompleto()">ğŸ’¾ Backup Completo</button>
                    <button class="btn-info" onclick="exportarContatosCSV()">ğŸ“Š Exportar CSV</button>
                    <button class="btn-warning" onclick="verificarSaudeDados()">ğŸ” Verificar Dados</button>
                </div>
                <div id="leads-container" class="data-table">
                    <div class="loading">â³ Carregando leads...</div>
                </div>
            </div>

            <div id="crm-contacts-tab" class="crm-tab">
                <div class="crm-actions">
                    <button class="btn-primary" onclick="loadContacts()">ğŸ”„ Carregar Contatos</button>
                    <button class="btn-success" onclick="fazerBackupCompleto()">ğŸ’¾ Backup Completo</button>
                    <button class="btn-info" onclick="exportarContatosCSV()">ğŸ“Š Exportar CSV</button>
                    <button class="btn-warning" onclick="verificarSaudeDados()">ğŸ” Verificar Dados</button>
                </div>
                <div id="contacts-container" class="data-table">
                    <div class="loading">â³ Carregando contatos...</div>
                </div>
            </div>

            <div id="crm-pipeline-tab" class="crm-tab">
                <div class="pipeline-stats">
                    <div class="stat-card">
                        <h3>ğŸ“¥ Novos</h3>
                        <p id="pipeline-novos">0</p>
                    </div>
                    <div class="stat-card">
                        <h3>ğŸ’¬ NegociaÃ§Ã£o</h3>
                        <p id="pipeline-negociacao">0</p>
                    </div>
                    <div class="stat-card">
                        <h3>âœ… Fechados</h3>
                        <p id="pipeline-fechados">0</p>
                    </div>
                    <div class="stat-card">
                        <h3>âŒ Perdidos</h3>
                        <p id="pipeline-perdidos">0</p>
                    </div>
                </div>
                <div id="pipeline-container" class="pipeline-view">
                    <div class="loading">â³ Carregando pipeline...</div>
                </div>
            </div>
        </section>
    </main>

    <script src="/js/dashboard.js"></script>
    <script>
        // FunÃ§Ãµes especÃ­ficas para contatos
        async function loadCrmLeads() {
            try {
                const response = await fetch('/api/contacts/unified');
                const data = await response.json();
                if (data.success) {
                    displayContacts(data.contacts, 'leads-container');
                }
            } catch (error) {
                console.error('Erro ao carregar leads:', error);
            }
        }

        async function loadContacts() {
            try {
                const response = await fetch('/api/contacts/unified');
                const data = await response.json();
                if (data.success) {
                    displayContacts(data.contacts, 'contacts-container');
                }
            } catch (error) {
                console.error('Erro ao carregar contatos:', error);
            }
        }

        function displayContacts(contacts, containerId) {
            const container = document.getElementById(containerId);
            if (!contacts || contacts.length === 0) {
                container.innerHTML = '<p>Nenhum contato encontrado.</p>';
                return;
            }

            const table = `
                <table class="contacts-table">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Email</th>
                            <th>Telefone</th>
                            <th>Empresa</th>
                            <th>Status</th>
                            <th>Criado em</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${contacts.map(contact => `
                            <tr>
                                <td>${contact.nome || 'N/A'}</td>
                                <td>${contact.email || 'N/A'}</td>
                                <td>${contact.telefone || 'N/A'}</td>
                                <td>${contact.empresa || 'N/A'}</td>
                                <td><span class="status-${contact.status || 'novo'}">${contact.status || 'Novo'}</span></td>
                                <td>${new Date(contact.criadoEm).toLocaleDateString('pt-BR')}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            container.innerHTML = table;
        }

        function showCrmTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.crm-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));

            // Show selected tab
            document.getElementById(`crm-${tabName}-tab`).classList.add('active');
            event.target.classList.add('active');

            // Load data for the tab
            if (tabName === 'leads') loadCrmLeads();
            else if (tabName === 'contacts') loadContacts();
        }

        // Load initial data
        document.addEventListener('DOMContentLoaded', () => {
            loadCrmLeads();
        });
    </script>
</body>
</html>