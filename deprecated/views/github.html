<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub - Avila Dashboard</title>
    <link rel="stylesheet" href="/css/dashboard.css">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96" />
</head>
<body>
    <nav class="top-navbar">
        <div class="navbar-brand" onclick="window.location.href='/dashboard'">
            <span class="brand-logo">ğŸš€</span>
            <h1>Avila Dashboard</h1>
        </div>
        <div class="navbar-menu">
            <div class="menu-item" onclick="window.location.href='/dashboard'">Dashboard</div>
            <div class="menu-item" onclick="window.location.href='/contacts'">Contatos</div>
            <div class="menu-item active">GitHub</div>
            <div class="menu-item" onclick="window.location.href='/payments'">Pagamentos</div>
        </div>
    </nav>

    <main class="main-content">
        <section class="section active">
            <div class="section-header">
                <h1>ğŸ™ GitHub Integration</h1>
                <p>Gerencie seus repositÃ³rios, atividades e integraÃ§Ãµes GitHub</p>
            </div>

            <div class="github-tabs">
                <button class="tab-btn active" onclick="showGitHubTab('repos')">ğŸ“ RepositÃ³rios</button>
                <button class="tab-btn" onclick="showGitHubTab('activity')">ğŸ“Š Atividades</button>
                <button class="tab-btn" onclick="showGitHubTab('stats')">ğŸ“ˆ EstatÃ­sticas</button>
            </div>

            <div id="github-repos-tab" class="github-tab active">
                <div class="github-actions">
                    <button class="btn-primary" onclick="loadGitHubRepos()">ğŸ”„ Atualizar RepositÃ³rios</button>
                    <button class="btn-secondary" onclick="syncGitHubData()">ğŸ”„ Sincronizar Dados</button>
                    <button class="btn-info" onclick="exportGitHubData()">ğŸ“Š Exportar Dados</button>
                </div>
                <div id="repos-container" class="data-table">
                    <div class="loading">â³ Carregando repositÃ³rios...</div>
                </div>
            </div>

            <div id="github-activity-tab" class="github-tab">
                <div class="github-actions">
                    <button class="btn-primary" onclick="loadGitHubActivity()">ğŸ”„ Atualizar Atividades</button>
                    <button class="btn-info" onclick="filterActivity('today')">ğŸ“… Hoje</button>
                    <button class="btn-info" onclick="filterActivity('week')">ğŸ“Š Semana</button>
                    <button class="btn-info" onclick="filterActivity('month')">ğŸ“† MÃªs</button>
                </div>
                <div id="activity-container" class="activity-feed">
                    <div class="loading">â³ Carregando atividades...</div>
                </div>
            </div>

            <div id="github-stats-tab" class="github-tab">
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>ğŸ“ Total de Repos</h3>
                        <p id="stats-repos">0</p>
                    </div>
                    <div class="stat-card">
                        <h3>â­ Stars Totais</h3>
                        <p id="stats-stars">0</p>
                    </div>
                    <div class="stat-card">
                        <h3>ğŸ´ Forks Totais</h3>
                        <p id="stats-forks">0</p>
                    </div>
                    <div class="stat-card">
                        <h3>ğŸ‘¥ Seguidores</h3>
                        <p id="stats-followers">0</p>
                    </div>
                </div>
                <div id="stats-container" class="stats-details">
                    <div class="loading">â³ Carregando estatÃ­sticas...</div>
                </div>
            </div>
        </section>
    </main>

    <script src="/js/dashboard.js"></script>
    <script>
        // FunÃ§Ãµes especÃ­ficas para GitHub
        async function loadGitHubRepos() {
            try {
                const response = await fetch('/api/github/repos');
                const data = await response.json();
                if (data.success) {
                    displayRepos(data.repos);
                }
            } catch (error) {
                console.error('Erro ao carregar repositÃ³rios:', error);
                document.getElementById('repos-container').innerHTML = '<p>Erro ao carregar repositÃ³rios. Verifique a configuraÃ§Ã£o do GitHub.</p>';
            }
        }

        async function loadGitHubActivity() {
            try {
                const response = await fetch('/api/github/activity');
                const data = await response.json();
                if (data.success) {
                    displayActivity(data.events);
                }
            } catch (error) {
                console.error('Erro ao carregar atividades:', error);
                document.getElementById('activity-container').innerHTML = '<p>Erro ao carregar atividades.</p>';
            }
        }

        function displayRepos(repos) {
            const container = document.getElementById('repos-container');
            if (!repos || repos.length === 0) {
                container.innerHTML = '<p>Nenhum repositÃ³rio encontrado.</p>';
                return;
            }

            const reposList = repos.map(repo => `
                <div class="repo-card">
                    <div class="repo-header">
                        <h3><a href="${repo.html_url}" target="_blank">${repo.name}</a></h3>
                        <span class="repo-visibility">${repo.visibility}</span>
                    </div>
                    <p class="repo-description">${repo.description || 'Sem descriÃ§Ã£o'}</p>
                    <div class="repo-stats">
                        <span>â­ ${repo.stargazers_count}</span>
                        <span>ğŸ´ ${repo.forks_count}</span>
                        <span>ğŸ‘€ ${repo.watchers_count}</span>
                        <span>ğŸ“ ${repo.language || 'N/A'}</span>
                    </div>
                    <div class="repo-dates">
                        <small>Criado: ${new Date(repo.created_at).toLocaleDateString('pt-BR')}</small>
                        <small>Atualizado: ${new Date(repo.updated_at).toLocaleDateString('pt-BR')}</small>
                    </div>
                </div>
            `).join('');

            container.innerHTML = `<div class="repos-grid">${reposList}</div>`;
        }

        function displayActivity(events) {
            const container = document.getElementById('activity-container');
            if (!events || events.length === 0) {
                container.innerHTML = '<p>Nenhuma atividade recente.</p>';
                return;
            }

            const activityList = events.slice(0, 20).map(event => `
                <div class="activity-item">
                    <div class="activity-icon">${getActivityIcon(event.type)}</div>
                    <div class="activity-content">
                        <p>${formatActivityMessage(event)}</p>
                        <small>${new Date(event.created_at).toLocaleString('pt-BR')}</small>
                    </div>
                </div>
            `).join('');

            container.innerHTML = `<div class="activity-list">${activityList}</div>`;
        }

        function getActivityIcon(type) {
            const icons = {
                'PushEvent': 'ğŸ“¤',
                'PullRequestEvent': 'ğŸ”„',
                'IssuesEvent': 'â“',
                'CreateEvent': 'â•',
                'DeleteEvent': 'ğŸ—‘ï¸',
                'ForkEvent': 'ğŸ´',
                'WatchEvent': 'ğŸ‘€'
            };
            return icons[type] || 'ğŸ“';
        }

        function formatActivityMessage(event) {
            // Simplified activity message formatting
            return `${event.type} em ${event.repo.name}`;
        }

        function showGitHubTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.github-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));

            // Show selected tab
            document.getElementById(`github-${tabName}-tab`).classList.add('active');
            event.target.classList.add('active');

            // Load data for the tab
            if (tabName === 'repos') loadGitHubRepos();
            else if (tabName === 'activity') loadGitHubActivity();
            else if (tabName === 'stats') loadGitHubStats();
        }

        async function loadGitHubStats() {
            // Load repos first to calculate stats
            try {
                const response = await fetch('/api/github/repos');
                const data = await response.json();
                if (data.success) {
                    const repos = data.repos;
                    const stats = {
                        repos: repos.length,
                        stars: repos.reduce((sum, repo) => sum + repo.stargazers_count, 0),
                        forks: repos.reduce((sum, repo) => sum + repo.forks_count, 0),
                        followers: data.user ? data.user.followers : 0
                    };

                    document.getElementById('stats-repos').textContent = stats.repos;
                    document.getElementById('stats-stars').textContent = stats.stars;
                    document.getElementById('stats-forks').textContent = stats.forks;
                    document.getElementById('stats-followers').textContent = stats.followers;

                    document.getElementById('stats-container').innerHTML = '<p>EstatÃ­sticas carregadas com sucesso!</p>';
                }
            } catch (error) {
                console.error('Erro ao carregar estatÃ­sticas:', error);
            }
        }

        // Load initial data
        document.addEventListener('DOMContentLoaded', () => {
            loadGitHubRepos();
        });
    </script>
</body>
</html>