<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pagamentos - Avila Dashboard</title>
    <link rel="stylesheet" href="/css/dashboard.css">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96" />
</head>
<body>
    <nav class="top-navbar">
        <div class="navbar-brand" onclick="window.location.href='/dashboard'">
            <span class="brand-logo">ğŸš€</span>
            <h1>Avila Dashboard</h1>
        </div>
        <div class="navbar-menu">
            <div class="menu-item" onclick="window.location.href='/dashboard'">Dashboard</div>
            <div class="menu-item" onclick="window.location.href='/contacts'">Contatos</div>
            <div class="menu-item" onclick="window.location.href='/github'">GitHub</div>
            <div class="menu-item active">Pagamentos</div>
        </div>
    </nav>

    <main class="main-content">
        <section class="section active">
            <div class="section-header">
                <h1>ğŸ’° GestÃ£o de Pagamentos</h1>
                <p>Gerencie pagamentos, saldo e transaÃ§Ãµes com Stripe e PayPal</p>
            </div>

            <div class="payments-tabs">
                <button class="tab-btn active" onclick="showPaymentsTab('overview')">ğŸ“Š VisÃ£o Geral</button>
                <button class="tab-btn" onclick="showPaymentsTab('stripe')">ğŸ’³ Stripe</button>
                <button class="tab-btn" onclick="showPaymentsTab('paypal')">ğŸ…¿ï¸ PayPal</button>
                <button class="tab-btn" onclick="showPaymentsTab('transactions')">ğŸ“ˆ TransaÃ§Ãµes</button>
            </div>

            <div id="payments-overview-tab" class="payments-tab active">
                <div class="balance-overview">
                    <div class="balance-card stripe-balance">
                        <h3>ğŸ’³ Saldo Stripe</h3>
                        <p id="stripe-balance">Carregando...</p>
                        <small>Saldo disponÃ­vel</small>
                    </div>
                    <div class="balance-card paypal-balance">
                        <h3>ğŸ…¿ï¸ Saldo PayPal</h3>
                        <p id="paypal-balance">R$ 0,00</p>
                        <small>Saldo disponÃ­vel</small>
                    </div>
                    <div class="balance-card total-balance">
                        <h3>ğŸ’° Total</h3>
                        <p id="total-balance">Carregando...</p>
                        <small>Saldo consolidado</small>
                    </div>
                </div>

                <div class="payments-actions">
                    <button class="btn-primary" onclick="refreshBalances()">ğŸ”„ Atualizar Saldos</button>
                    <button class="btn-secondary" onclick="generateReport()">ğŸ“Š Gerar RelatÃ³rio</button>
                    <button class="btn-info" onclick="exportTransactions()">ğŸ“¤ Exportar TransaÃ§Ãµes</button>
                </div>
            </div>

            <div id="payments-stripe-tab" class="payments-tab">
                <div class="stripe-actions">
                    <button class="btn-primary" onclick="loadStripeBalance()">ğŸ”„ Carregar Saldo</button>
                    <button class="btn-secondary" onclick="loadStripeCharges()">ğŸ“‹ Carregar CobranÃ§as</button>
                    <button class="btn-info" onclick="loadStripeCustomers()">ğŸ‘¥ Carregar Clientes</button>
                </div>

                <div id="stripe-balance-container" class="data-section">
                    <h3>Saldo Detalhado</h3>
                    <div class="loading">â³ Carregando saldo...</div>
                </div>

                <div id="stripe-charges-container" class="data-section">
                    <h3>Ãšltimas CobranÃ§as</h3>
                    <div class="loading">â³ Carregando cobranÃ§as...</div>
                </div>

                <div id="stripe-customers-container" class="data-section">
                    <h3>Clientes</h3>
                    <div class="loading">â³ Carregando clientes...</div>
                </div>
            </div>

            <div id="payments-paypal-tab" class="payments-tab">
                <div class="paypal-content">
                    <div class="coming-soon">
                        <h3>ğŸ…¿ï¸ PayPal Integration</h3>
                        <p>IntegraÃ§Ã£o com PayPal em desenvolvimento.</p>
                        <p>Funcionalidades previstas:</p>
                        <ul>
                            <li>Saldo da conta</li>
                            <li>TransaÃ§Ãµes recentes</li>
                            <li>Gerenciamento de pagamentos</li>
                            <li>RelatÃ³rios financeiros</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div id="payments-transactions-tab" class="payments-tab">
                <div class="transactions-actions">
                    <button class="btn-primary" onclick="loadAllTransactions()">ğŸ”„ Carregar Todas</button>
                    <button class="btn-info" onclick="filterTransactions('today')">ğŸ“… Hoje</button>
                    <button class="btn-info" onclick="filterTransactions('week')">ğŸ“Š Semana</button>
                    <button class="btn-info" onclick="filterTransactions('month')">ğŸ“† MÃªs</button>
                </div>

                <div id="transactions-container" class="data-table">
                    <div class="loading">â³ Carregando transaÃ§Ãµes...</div>
                </div>
            </div>
        </section>
    </main>

    <script src="/js/dashboard.js"></script>
    <script>
        // FunÃ§Ãµes especÃ­ficas para pagamentos
        async function refreshBalances() {
            await loadStripeBalance();
            // PayPal balance would be loaded here when implemented
            updateTotalBalance();
        }

        async function loadStripeBalance() {
            try {
                const response = await fetch('/api/payments/stripe/balance');
                const data = await response.json();
                if (data.success) {
                    displayStripeBalance(data.balance);
                    displayStripeCharges(data.charges);
                    displayStripeCustomers(data.customers);
                }
            } catch (error) {
                console.error('Erro ao carregar dados do Stripe:', error);
                document.getElementById('stripe-balance').textContent = 'Erro ao carregar';
            }
        }

        function displayStripeBalance(balance) {
            const amount = balance.available ? balance.available[0]?.amount / 100 : 0;
            const currency = balance.available ? balance.available[0]?.currency.toUpperCase() : 'BRL';

            document.getElementById('stripe-balance').textContent = `R$ ${amount.toFixed(2)}`;
            document.getElementById('stripe-balance-container').innerHTML = `
                <div class="balance-details">
                    <p><strong>Saldo DisponÃ­vel:</strong> R$ ${amount.toFixed(2)} ${currency}</p>
                    <p><strong>Saldo Pendente:</strong> R$ ${(balance.pending ? balance.pending[0]?.amount / 100 : 0).toFixed(2)} ${currency}</p>
                </div>
            `;
        }

        function displayStripeCharges(charges) {
            const container = document.getElementById('stripe-charges-container');
            if (!charges || charges.length === 0) {
                container.innerHTML = '<p>Nenhuma cobranÃ§a encontrada.</p>';
                return;
            }

            const chargesList = charges.slice(0, 10).map(charge => `
                <div class="charge-item">
                    <div class="charge-header">
                        <span class="charge-id">${charge.id}</span>
                        <span class="charge-amount">R$ ${(charge.amount / 100).toFixed(2)}</span>
                        <span class="charge-status status-${charge.status}">${charge.status}</span>
                    </div>
                    <div class="charge-details">
                        <p><strong>Cliente:</strong> ${charge.customer || 'N/A'}</p>
                        <p><strong>Data:</strong> ${new Date(charge.created * 1000).toLocaleDateString('pt-BR')}</p>
                        <p><strong>DescriÃ§Ã£o:</strong> ${charge.description || 'Sem descriÃ§Ã£o'}</p>
                    </div>
                </div>
            `).join('');

            container.innerHTML = `<div class="charges-list">${chargesList}</div>`;
        }

        function displayStripeCustomers(customers) {
            const container = document.getElementById('stripe-customers-container');
            if (!customers || customers.length === 0) {
                container.innerHTML = '<p>Nenhum cliente encontrado.</p>';
                return;
            }

            const customersList = customers.slice(0, 10).map(customer => `
                <div class="customer-item">
                    <div class="customer-header">
                        <h4>${customer.name || customer.email}</h4>
                        <span class="customer-email">${customer.email}</span>
                    </div>
                    <div class="customer-details">
                        <p><strong>ID:</strong> ${customer.id}</p>
                        <p><strong>Criado em:</strong> ${new Date(customer.created * 1000).toLocaleDateString('pt-BR')}</p>
                    </div>
                </div>
            `).join('');

            container.innerHTML = `<div class="customers-list">${customersList}</div>`;
        }

        function updateTotalBalance() {
            const stripeBalance = parseFloat(document.getElementById('stripe-balance').textContent.replace('R$ ', '').replace(',', '.')) || 0;
            const paypalBalance = parseFloat(document.getElementById('paypal-balance').textContent.replace('R$ ', '').replace(',', '.')) || 0;
            const total = stripeBalance + paypalBalance;
            document.getElementById('total-balance').textContent = `R$ ${total.toFixed(2)}`;
        }

        function showPaymentsTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.payments-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));

            // Show selected tab
            document.getElementById(`payments-${tabName}-tab`).classList.add('active');
            event.target.classList.add('active');

            // Load data for the tab
            if (tabName === 'overview') refreshBalances();
            else if (tabName === 'stripe') loadStripeBalance();
            else if (tabName === 'paypal') {
                // PayPal implementation pending
            }
            else if (tabName === 'transactions') loadAllTransactions();
        }

        async function loadAllTransactions() {
            // For now, load Stripe charges as transactions
            await loadStripeBalance();
        }

        // Load initial data
        document.addEventListener('DOMContentLoaded', () => {
            refreshBalances();
        });
    </script>
</body>
</html>